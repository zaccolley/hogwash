<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Uni Comps Thing</title>
</head>
<style>
	canvas{ width: 100px; }
</style>
<body>

	<section id="lib">
		<canvas id="lib-canvas" height="200" width="200"></canvas>
		<h1></h1>
	</section>

	<section id="par">
		<canvas id="par-canvas" height="200" width="200"></canvas>
		<h1></h1>
	</section>

	<section id="por">
		<canvas id="por-canvas" height="200" width="200"></canvas>
		<h1></h1>
	</section>

	<section id="ang">
		<canvas id="ang-canvas" height="200" width="200"></canvas>
		<h1></h1>
	</section>

	<p></p>

	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script type="text/javascript">

		function drawBuilding(ctx, width, height, percent, colour){
			ctx.fillStyle = '#000';
			ctx.beginPath();
			ctx.moveTo(width / 2, 0);			
			ctx.lineTo(width, height / 2);
			ctx.lineTo(width - 30, height / 2);
			ctx.lineTo(width - 30, height);
			ctx.lineTo(30, height);
			ctx.lineTo(30, height / 2);
			ctx.lineTo(0, height / 2);
			ctx.closePath();
			ctx.clip();

			ctx.fillStyle = '#DDD';
			ctx.fillRect(0, 0, width, height);

			var amount = (percent / 100) * height;
			console.log(amount);

			ctx.fillStyle = colour;
			ctx.fillRect(0, height - amount, width, height);
		}
		
		var buildings = [];

		var geoLat = '';
		var geoLon = '';

		$.get('data.php', function(data){
			var data = data.substring(1, data.length-1).split(',');
			console.log(data);

			var lib = {
				name: 'library',
				avail: +data[0],
				pcs: {
					free: +data[1],
					total: +data[2]
				},
				coords: {
					lat: 50.792470,
					lon: -1.098845
				}
			};

			var par = {
				name: 'park',
				avail: +data[4],
				pcs: {
					free: +data[5],
					total: +data[6]
				},
				coords: {
					lat: 50.797570,
					lon: -1.094108
				}
			};

			var por = {
				name: 'portland',
				avail: +data[8],
				pcs: {
					free: data[9],
					total: data[10]
				},
				coords: {
					lat: 50.798454,
					lon: -1.099490
				}
			};

			var ang = {
				name: 'anglesea',
				avail: +data[12],
				pcs: {
					free: +data[13],
					total: +data[14]
				},
				coords: {
					lat: 50.797709,
					lon: -1.096582
				}
			};

			buildings = [lib, par, por, ang];

			for(var i = 0; i < buildings.length; i++){

				var build = buildings[i];
				console.log(build);

				var id = build.name.substring(0, 3);

				var avail = (build.avail) ? 'open' : 'closed';

				var output = '"'+ build.name +'" is '+ avail;

				var percent = (build.pcs.free / build.pcs.total) * 100;

				if(build.avail){
					output += ' and there are '
						   + build.pcs.free +'/'+ build.pcs.total
						   + ' computers free';
				}

				output += '.';
				$('#'+id).find('h1').html(output);

				if(geoLat && geoLon){
					build.distance = getDistanceFromLatLonInKm(geoLat, geoLon, build.coords.lat, build.coords.lon);
				}

				console.log('Current geo: ', geoLat, geoLon);
				console.log('Distance: ', build.distance);
				
				var canvas = document.getElementById(id+'-canvas');
				if (canvas.getContext){
					var ctx = canvas.getContext('2d');
					var width = canvas.width;
					var height = canvas.height;

					var colour = 'rgb(0,255,0)';
					if(percent < 75){ colour = 'rgb(255,255,0)'; }
					if(percent < 50){ colour = 'rgb(255,155,0)'; }
					if(percent < 25 ){ colour = 'rgb(255,55,0)'; }
					if(!build.avail){ colour = 'rgba(0,0,0,0)'; }

					drawBuilding(ctx, width, height, percent, colour);
				}

			
			}

			var smallestD = buildings[0];

			for(var j = 0; j < buildings.length; j++){
				var build = buildings[j];
				if(build.avail && build.distance < smallestD.distance){ smallestD = build; }
			}

			console.log(smallestD);
	
			$('p').html('The '+ smallestD.name +'\'s are the closest available PCs.');
		});

		navigator.geolocation.getCurrentPosition(geoData, geoError);

		function geoData(pos){
			geoLat = pos.coords.latitude;
			geoLon = pos.coords.longitude;
		}

		function geoError(){ console.log('No geolocation. :(');	}

		// http://stackoverflow.com/questions/27928/how-do-i-calculate-distance-between-two-latitude-longitude-points

		function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2){
			var R = 6371; // Radius of the earth in km
			var dLat = deg2rad(lat2-lat1);  // deg2rad below
			var dLon = deg2rad(lon2-lon1); 
			var a = 
				Math.sin(dLat/2) * Math.sin(dLat/2) +
				Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
				Math.sin(dLon/2) * Math.sin(dLon/2)
				; 
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
			var d = R * c; // Distance in km
			return d;
		}

		function deg2rad(deg){
			return deg * (Math.PI/180)
		}

	</script>
	
</body>
</html>